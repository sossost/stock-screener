# Feature Specification: Golden Cross 스크리너 성장률 필터 기능

**Feature Branch**: `feature/golden-cross-growth-rate-filter`  
**Created**: 2025-01-27  
**Status**: Draft

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 매출 성장률 필터로 종목 선별 (Priority: P1)

투자자가 Golden Cross 정배열 조건을 만족하는 종목 중에서 **선택한 N분기 동안 평균 매출 성장률이 X% 이상인 기업**을 선별하여 높은 성장률을 가진 종목을 찾을 수 있어야 합니다.

**Why this priority**:

- 단순한 연속 증가보다 더 정교한 성장률 기준 적용
- 투자자가 원하는 최소 성장률 기준을 직접 설정 가능
- 빠르게 성장하는 기업을 더 정확하게 발굴

**Independent Test**:

- 매출 성장 필터 선택 시 선택한 N분기 동안 평균 성장률이 입력한 성장률 이상인 종목만 표시
- 분기 수 설정 (2~8분기) 가능
- 성장률 입력 (0~1000%, 기본값 30%) 가능
- 데이터베이스 쿼리 결과와 화면 표시 일치 확인

**Acceptance Scenarios**:

1. **Given** Golden Cross 페이지 접속, **When** "매출 성장" 필터 선택하고 분기 수 4, 성장률 30% 설정, **Then** 최근 4분기 평균 매출 성장률이 30% 이상인 기업만 표시
2. **Given** 매출 성장 필터 선택된 상태, **When** 분기 수를 6으로, 성장률을 50%로 변경, **Then** 최근 6분기 평균 매출 성장률이 50% 이상인 기업만 표시
3. **Given** 매출 성장 필터 선택된 상태, **When** 필터 해제, **Then** 모든 Golden Cross 종목 표시
4. **Given** 매출 데이터 부족한 종목 (N분기 미만), **When** 매출 성장 필터 선택, **Then** 해당 종목은 표시되지 않음
5. **Given** 이전 분기 대비 음수 성장률이 포함된 종목, **When** 평균 성장률 계산, **Then** 음수 성장률도 포함하여 평균 계산 (예: Q1: +50%, Q2: -20%, Q3: +30%, Q4: +10% → 평균 17.5%)

---

### User Story 2 - EPS 성장률 필터로 종목 선별 (Priority: P1)

투자자가 Golden Cross 정배열 조건을 만족하는 종목 중에서 **선택한 N분기 동안 평균 EPS 성장률이 X% 이상인 기업**을 선별하여 수익성과 높은 성장률을 동시에 갖춘 종목을 찾을 수 있어야 합니다.

**Why this priority**:

- EPS 성장률 기준으로 수익성과 성장성을 동시에 평가
- 높은 수익성 성장 기업을 정밀하게 필터링
- 매출 성장률과 함께 사용하여 고품질 종목 선별

**Independent Test**:

- EPS 성장 필터 선택 시 선택한 N분기 동안 평균 성장률이 입력한 성장률 이상인 종목만 표시
- 분기 수 설정 (2~8분기) 가능
- 성장률 입력 (0~1000%, 기본값 30%) 가능
- 데이터베이스 쿼리 결과와 화면 표시 일치 확인

**Acceptance Scenarios**:

1. **Given** Golden Cross 페이지 접속, **When** "수익 성장" 필터 선택하고 분기 수 3, 성장률 30% 설정, **Then** 최근 3분기 평균 EPS 성장률이 30% 이상인 기업만 표시
2. **Given** EPS 성장 필터 선택된 상태, **When** 분기 수를 5로, 성장률을 40%로 변경, **Then** 최근 5분기 평균 EPS 성장률이 40% 이상인 기업만 표시
3. **Given** EPS 성장 필터 선택된 상태, **When** 필터 해제, **Then** 모든 Golden Cross 종목 표시
4. **Given** EPS 데이터 부족한 종목 (N분기 미만), **When** EPS 성장 필터 선택, **Then** 해당 종목은 표시되지 않음
5. **Given** EPS가 음수에서 양수로 전환된 종목, **When** 성장률 계산, **Then** 적절한 처리 (예: -1.0 → +0.5는 150% 증가로 계산)

---

### User Story 3 - 복합 성장률 필터 조합 (Priority: P2)

투자자가 **매출 성장률 + EPS 성장률** 필터를 조합하여 고성장 기업을 정밀하게 선별할 수 있어야 합니다.

**Why this priority**:

- 다중 성장률 필터로 더 정교한 종목 선별
- 매출과 수익성 성장을 동시에 만족하는 우량 기업 발굴
- 투자 리스크 최소화 및 수익성 극대화

**Independent Test**:

- 매출 성장률 + EPS 성장률 필터 동시 적용
- 각 필터의 독립적 동작 확인
- 필터 조합에 따른 결과 집합 변화 확인

**Acceptance Scenarios**:

1. **Given** 매출 성장률 30% 필터와 EPS 성장률 30% 필터 모두 선택, **When** 필터 적용, **Then** 두 조건을 모두 만족하는 종목만 표시
2. **Given** 복합 필터 적용된 상태, **When** 일부 필터 해제, **Then** 해당 조건이 제외된 결과 표시
3. **Given** 복합 필터 적용된 상태, **When** 필터 초기화, **Then** 모든 Golden Cross 종목 표시

---

### User Story 4 - 성장률 필터 UI/UX (Priority: P2)

투자자가 직관적이고 사용하기 쉬운 인터페이스로 성장률 필터를 설정할 수 있어야 합니다.

**Why this priority**:

- 사용자 경험 개선
- 필터 설정의 명확성 확보
- 실수 방지 및 효율적인 필터링

**Independent Test**:

- 필터 활성화 시에만 분기 수 및 성장률 입력 필드 활성화
- 입력값 유효성 검사 (분기 수: 2-8, 성장률: 0-1000%)
- 기본값 설정 (분기 수: 3, 성장률: 30%)
- 입력 중에는 API 호출하지 않고, Enter 또는 blur 시에만 적용

**Acceptance Scenarios**:

1. **Given** 필터 비활성화 상태, **When** 필터 UI 확인, **Then** 분기 수 및 성장률 입력 필드가 비활성화되어 있음
2. **Given** 필터 활성화 상태, **When** 잘못된 값 입력 (분기 수 10, 성장률 -10%), **Then** 기본값으로 복원되거나 유효한 범위로 제한
3. **Given** 필터 활성화 상태, **When** 값 입력 중, **Then** API 호출이 발생하지 않음
4. **Given** 필터 활성화 상태, **When** Enter 키 입력 또는 입력 필드 blur, **Then** 필터가 적용되고 API 호출 발생

## Functional Requirements

### FR1: 매출 성장률 필터

- **Description**: 선택한 N분기 동안 평균 매출 성장률이 X% 이상인 기업을 필터링
- **Input**:
  - 분기 수 (2~8, 기본값 3)
  - 최소 성장률 (0~1000%, 기본값 30%)
- **Logic**:
  - 최근 N분기의 매출 데이터를 순차적으로 비교하여 분기별 성장률 계산
  - 분기별 성장률 = (현재 분기 매출 - 이전 분기 매출) / 이전 분기 매출 × 100
  - 평균 성장률 = 모든 분기별 성장률의 평균
  - 평균 성장률이 입력한 성장률 이상인 종목만 필터링
- **Output**: 조건을 만족하는 종목만 표시

### FR2: EPS 성장률 필터

- **Description**: 선택한 N분기 동안 평균 EPS 성장률이 X% 이상인 기업을 필터링
- **Input**:
  - 분기 수 (2~8, 기본값 3)
  - 최소 성장률 (0~1000%, 기본값 30%)
- **Logic**:
  - 최근 N분기의 EPS 데이터를 순차적으로 비교하여 분기별 성장률 계산
  - 분기별 성장률 = (현재 분기 EPS - 이전 분기 EPS) / 이전 분기 EPS × 100
  - 평균 성장률 = 모든 분기별 성장률의 평균
  - 평균 성장률이 입력한 성장률 이상인 종목만 필터링
  - 이전 분기 EPS가 0이거나 NULL인 경우 처리 (예: 음수에서 양수 전환)
- **Output**: 조건을 만족하는 종목만 표시

### FR3: 성장률 계산 로직

- **Description**: 분기별 성장률을 정확하게 계산하고 평균 내기
- **Input**: 최근 N분기의 재무 데이터 (매출 또는 EPS)
- **Logic**:
  - 각 분기별로 이전 분기 대비 성장률 계산
  - 분기별 성장률 배열 생성
  - 평균 성장률 계산 (산술 평균)
  - 특수 케이스 처리:
    - 이전 분기 값이 0인 경우: 무한대 또는 별도 처리
    - 이전 분기 값이 음수에서 양수로 전환: 적절한 계산식 적용
    - NULL 값이 포함된 경우: 해당 분기는 제외하고 계산
- **Output**: 평균 성장률 (%)

### FR4: 필터 UI/UX

- **Description**: 직관적이고 사용하기 쉬운 필터 인터페이스
- **Input**:
  - 체크박스 (필터 활성화/비활성화)
  - 분기 수 입력 필드 (숫자)
  - 성장률 입력 필드 (숫자, 소수점 허용)
- **Logic**:
  - 필터 활성화 시에만 분기 수 및 성장률 입력 가능
  - 입력값 유효성 검사 (분기 수: 2-8, 성장률: 0-1000%)
  - 입력 중에는 API 호출하지 않음 (debounce 또는 blur/Enter 시 적용)
  - 기본값 설정 및 복원 기능
- **Output**: 명확한 필터 상태 표시

## Non-Functional Requirements

### NFR1: 성능

- **Response Time**: 필터 적용 시 3초 이내 응답
- **Data Volume**: 최대 8분기 × 1000개 종목 데이터 처리
- **Caching**: 필터별 캐시 태그로 효율적 캐싱 (성장률 파라미터 포함)
- **Query Optimization**: SQL 쿼리에서 성장률 계산 최적화

### NFR2: 사용성

- **Accessibility**: 키보드 네비게이션 지원
- **Responsive**: 모바일/태블릿 대응
- **Intuitive**: 필터 상태가 명확하게 표시 (예: "최근 4분기 평균 매출 성장률 30% 이상")
- **Input Validation**: 실시간 유효성 검사 및 피드백

### NFR3: 데이터 품질

- **Accuracy**: 데이터베이스 쿼리 결과와 화면 표시 일치
- **Completeness**: 데이터 부족 시 적절한 처리 (N분기 미만 데이터는 필터링에서 제외)
- **Consistency**: 필터 적용 시 일관된 결과
- **Edge Cases**: 음수 값, 0 값, NULL 값 처리

### NFR4: 계산 정확도

- **Precision**: 성장률 계산 시 소수점 처리 (최소 소수점 2자리)
- **Rounding**: 평균 계산 시 적절한 반올림 처리
- **Edge Cases**: 극단적인 값 (예: 1000% 이상 성장) 처리

## API Contract

**Request Parameters**:

- `revenueGrowth`: 매출 성장 필터 활성화 여부 (boolean)
- `revenueGrowthQuarters`: 매출 성장 분기 수 (2-8, 기본값 3)
- `revenueGrowthRate`: 매출 최소 성장률 (0-1000, 기본값 30, 단위: %)
- `incomeGrowth`: 수익 성장 필터 활성화 여부 (boolean)
- `incomeGrowthQuarters`: 수익 성장 분기 수 (2-8, 기본값 3)
- `incomeGrowthRate`: EPS 최소 성장률 (0-1000, 기본값 30, 단위: %)
- 기존 필터들: `justTurned`, `lookbackDays`, `minMcap`, `minPrice`, `minAvgVol`, `allowOTC`, `profitability`

**Response Format**:

- `data`: Golden Cross 조건을 만족하는 종목 배열
- 각 종목은 다음 필드 포함:
  - `revenue_growth_quarters`: 연속 매출 성장 분기 수 (기존 필드)
  - `income_growth_quarters`: 연속 EPS 성장 분기 수 (기존 필드)
  - `revenue_avg_growth_rate`: 최근 N분기 평균 매출 성장률 (새 필드, %)
  - `income_avg_growth_rate`: 최근 N분기 평균 EPS 성장률 (새 필드, %)
- `quarterly_financials`: 최근 8분기 재무 데이터 (매출, 순이익, EPS)
- `totalCount`: 필터링된 종목 수
- `trade_date`: 데이터 기준일

## Database Schema Changes

**기존 테이블 활용**:

- `quarterly_financials` 테이블의 기존 컬럼 활용
- 추가 컬럼 생성 없이 기존 데이터로 성장률 계산
- `revenue`, `eps_diluted` 필드를 사용하여 성장률 분석

**데이터 요구사항**:

- 최근 8분기 재무 데이터 필요
- 매출(`revenue`) 및 EPS(`eps_diluted`) 데이터의 연속성 확인
- 분기별 순차적 비교를 통한 성장률 계산
- NULL 값 처리 로직 필요

**SQL 쿼리 로직**:

- 최근 N분기 데이터를 ORDER BY period_end_date DESC로 정렬
- LAG 함수를 사용하여 이전 분기 값과 비교
- 분기별 성장률 계산: (현재값 - 이전값) / 이전값 × 100
- 평균 성장률 계산: AVG(분기별 성장률)
- 필터링 조건: 평균 성장률 >= 입력한 성장률

## UI/UX Requirements

### 필터 섹션

- 매출 성장 필터:
  - 체크박스 (필터 활성화/비활성화)
  - 분기 수 입력 필드 (2-8, 기본값 3)
  - 성장률 입력 필드 (0-1000%, 기본값 30%, 소수점 허용)
  - 필터 비활성화 시 모든 입력 필드 비활성화
- EPS 성장 필터:
  - 체크박스 (필터 활성화/비활성화)
  - 분기 수 입력 필드 (2-8, 기본값 3)
  - 성장률 입력 필드 (0-1000%, 기본값 30%, 소수점 허용)
  - 필터 비활성화 시 모든 입력 필드 비활성화
- 기존 필터들과 일관된 디자인
- 입력 필드에 적절한 placeholder 및 라벨 표시

### 필터 상태 표시

- 테이블 캡션에 필터 조건 표시:
  - 예: "최근 4분기 평균 매출 성장률 30% 이상"
  - 예: "최근 3분기 평균 EPS 성장률 40% 이상"
- 필터가 적용된 경우 명확하게 표시

### 입력 처리

- 입력 중에는 API 호출하지 않음
- Enter 키 또는 blur 시에만 필터 적용
- 유효하지 않은 값 입력 시 기본값으로 복원 또는 경고 표시
- 입력 필드에 유효 범위 표시 (min, max)

### 반응형 디자인

- 모바일: 필터 세로 배치, 입력 필드 크기 조정
- 태블릿: 필터 가로 배치, 적절한 입력 필드 크기
- 데스크톱: 최적화된 레이아웃

## Success Metrics

### 기능적 성공 지표

- [ ] 매출 성장률 필터 정상 작동 (기본값: 3분기, 30%)
- [ ] EPS 성장률 필터 정상 작동 (기본값: 3분기, 30%)
- [ ] 성장률 계산 정확도 검증 (테스트 케이스 통과)
- [ ] 복합 필터 조합 정상 작동
- [ ] 엣지 케이스 처리 (음수, 0, NULL)

### 성능 지표

- [ ] 필터 적용 시 응답 시간 3초 이내
- [ ] 1000개 종목 데이터 처리 가능
- [ ] 캐시 효율성 90% 이상
- [ ] SQL 쿼리 실행 시간 최적화

### 사용성 지표

- [ ] 필터 UI 직관성 (사용자 테스트 통과)
- [ ] 모바일 반응형 정상 작동
- [ ] 접근성 가이드라인 준수
- [ ] 입력 유효성 검사 정상 작동

## Dependencies

### 내부 의존성

- 기존 Golden Cross 스크리너 기능
- `quarterly_financials` 테이블 데이터
- 기존 캐싱 시스템
- 기존 성장 필터 UI 컴포넌트 (`GrowthFilterControls`)

### 외부 의존성

- 재무 데이터 제공 API
- 데이터베이스 성능 (쿼리 최적화 필요)

## Risks & Mitigation

### 기술적 리스크

- **복잡한 SQL 쿼리로 인한 성능 저하**
  - _Mitigation_: 인덱스 최적화, 쿼리 튜닝, 서브쿼리 최적화
- **성장률 계산 로직의 복잡성**
  - _Mitigation_: 단위 테스트 작성, 엣지 케이스 철저히 테스트
- **N분기 데이터 부족으로 인한 빈 결과**
  - _Mitigation_: 데이터 유효성 검사, 적절한 에러 처리, 사용자에게 명확한 피드백

### 사용자 경험 리스크

- **필터 조합으로 인한 결과 집합 축소**
  - _Mitigation_: 필터 상태 명확 표시, 초기화 기능, 결과 개수 표시
- **성장률 계산 방식의 이해도 부족**
  - _Mitigation_: 명확한 라벨 및 도움말, 예시 제공
- **입력값 범위 혼란**
  - _Mitigation_: placeholder 및 라벨에 범위 명시, 실시간 유효성 검사

### 데이터 품질 리스크

- **음수 또는 0 값 처리**
  - _Mitigation_: 명확한 계산 로직 정의, 엣지 케이스 처리
- **NULL 값 처리**
  - _Mitigation_: NULL 값이 포함된 분기는 제외하고 계산, 사용자에게 명확히 표시

## Edge Cases & Special Handling

### 성장률 계산 특수 케이스

1. **이전 분기 값이 0인 경우**

   - 매출: 이전 분기 0 → 현재 분기 양수: 무한대 성장률 또는 별도 플래그 설정
   - EPS: 이전 분기 0 → 현재 분기 양수: 무한대 성장률 또는 별도 플래그 설정

2. **음수에서 양수로 전환**

   - 매출: 이전 분기 -1000만 → 현재 분기 +5000만: 적절한 계산식 적용
   - EPS: 이전 분기 -1.0 → 현재 분기 +0.5: 150% 증가로 계산

3. **NULL 값 포함**

   - NULL 값이 포함된 분기는 제외하고 계산
   - 예: 4분기 중 1개 분기가 NULL인 경우, 3개 분기로 평균 계산

4. **극단적인 성장률**
   - 1000% 이상의 성장률도 처리 가능하도록 설계
   - UI에서 큰 값 입력 가능하도록 설정

## Out of Scope

- 실시간 데이터 업데이트 (기존 일일 배치 유지)
- 추가 재무 지표 필터 (현재 매출, EPS만)
- 성장률 계산 방식 선택 (현재 산술 평균만)
- 연속 성장 필터와 성장률 필터의 동시 적용 로직 (현재 각각 독립적으로 동작)
- 성장률 차트 시각화 (현재 필터링 기능만)
