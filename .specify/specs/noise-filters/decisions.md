# noise-filters - 의사결정 기록 (ADR)

## ADR-NF-001: VCP 필터를 ETL에서 사전 계산

**날짜**: 2025-12-05  
**상태**: ✅ 채택  
**단계**: 스펙  

### 상황

- 노이즈 필터 중 VCP(Volatility Compression Pattern) 필터는:
  - ATR(14) 계산: True Range + Wilder's Smoothing (14일 윈도우)
  - Bollinger Band 계산: 20일 SMA + STDDEV + 60일 평균 비교
  - **60일 이상의 데이터 스캔**이 필요하여 쿼리 비용이 매우 큼
- 스크리너 쿼리에서 실시간으로 계산할 경우:
  - 모든 후보 종목에 대해 60일 데이터를 스캔해야 함
  - 쿼리 실행 시간이 2~3배 증가할 가능성
  - 기존 복잡한 쿼리와 조합 시 체감 성능 저하 발생

### 고려 사항

**옵션 1**: 실시간 CTE 계산  
- ✅ 추가 테이블/ETL 없이 바로 동작  
- ✅ 필터 조건 변경이 쉬움  
- ❌ 쿼리 복잡도와 실행 시간이 크게 증가  
- ❌ MA/성장성 필터와 조합 시 느려짐  

**옵션 2**: ETL에서 신호 테이블로 사전 계산 (선택)  
- ✅ 복잡한 윈도우 함수를 하루 한 번만 실행  
- ✅ 스크리너 쿼리는 JOIN + WHERE 수준으로 단순화  
- ✅ 동일 신호를 다른 기능에서도 재사용 가능  
- ✅ `breakout-trading-filters`와 동일한 패턴으로 일관성 유지  
- ❌ ETL 파이프라인/테이블 추가 관리 필요  
- ❌ 필터 조건 변경 시 ETL 수정 필요  

**옵션 3**: VCP 필터 단순화  
- ✅ 실시간 계산 가능  
- ❌ Bollinger Band 대신 단순 STDDEV 비교로 정확도 저하  
- ❌ ATR 계산은 여전히 필요하여 성능 이슈 존재  

### 결정

**옵션 2 채택**: VCP 필터를 ETL에서 사전 계산 후, 스크리너는 신호 테이블만 JOIN

- `apps/web/src/etl/jobs/build-noise-signals.ts`에서 EOD 기준(최신 거래일)의 가격 데이터를 사용해:
  - ATR(14) 계산
  - Bollinger Band 폭 계산 (20일 현재 vs 60일 평균)
  - VCP 조건 판단: `ATR(14) / close < 5% AND BB 폭 < 60일 평균 * 0.8`
- 결과를 `daily_noise_signals` 테이블에 저장:
  - `symbol`, `date`
  - `atr14`, `atr14Percent`, `bbWidthCurrent`, `bbWidthAvg60d`, `isVcp`
  - `(symbol, date)` 유니크 + `date + is_vcp` 인덱스
- 스크리너 쿼리(`query-builder.ts`)에서는:
  - `LEFT JOIN daily_noise_signals dns ON dns.symbol = cand.symbol AND dns.date::date = cand.d`
  - `vcpFilter = true` → `AND dns.is_vcp IS TRUE`

### 근거

1. **성능**:  
   - 복잡한 윈도우 함수(ATR, Bollinger Band)를 실시간으로 돌리지 않고, ETL에서 하루 한 번만 수행.  
   - 스크리너 쿼리는 기존 기본 필터 수준의 응답 속도로 유지 가능.
2. **일관성**:  
   - `breakout-trading-filters`에서 동일한 패턴(ADR-BTF-001)을 채택하여 프로젝트 전반의 일관성 유지.
3. **확장성**:  
   - 동일한 노이즈 신호를 사용하는 기능(스크리너, 알림 등)이 `daily_noise_signals`를 단일 소스로 공유.
4. **테스트/운영 용이성**:  
   - VCP 로직을 하나의 ETL 스크립트로 모아두면, 테스트/벤치마크/모니터링 포인트가 명확해짐.

### 결과

- 스크리너는 항상 **최신 EOD 기준 신호**만 표시 (intraday는 지원하지 않음).
- ETL 파이프라인에 `build-noise-signals` 단계가 추가되며, 실행 순서:
  - `prices → MA/RS → ratios → breakout-signals → noise-signals → alerts`
- ETL 실패 시:
  - 가격/MA/RS/비율은 최신이지만,
  - 노이즈 필터는 직전 성공 시점 기준으로 동작할 수 있으므로 로그/모니터링 필요.

---

## ADR-NF-002: 모든 노이즈 필터를 ETL로 사전 계산

**날짜**: 2025-12-05  
**상태**: ✅ 채택  
**단계**: 스펙  

### 상황

- 노이즈 필터 중:
  - **거래량 필터**: 20일 평균 계산 (윈도우 함수)
  - **VCP 필터**: ATR(14) + Bollinger Band 계산 (복잡)
  - **캔들 몸통 필터**: 최신 거래일만 필요 (간단한 계산)
  - **이평선 밀집 필터**: 최신 거래일만 필요 (간단한 계산)
- VCP 필터는 복잡하여 ETL로 사전 계산이 필요
- 나머지 필터는 간단하지만, 일관성을 위해 계산 방식 통일 필요

### 고려 사항

**옵션 1**: 모든 필터를 ETL로 사전 계산 (선택)  
- ✅ 일관성: 모든 노이즈 필터를 동일한 방식으로 관리  
- ✅ 성능: 스크리너 쿼리는 JOIN + WHERE 수준으로 단순화  
- ✅ 확장성: 향후 노이즈 필터 추가 시 동일한 패턴 적용 가능  
- ❌ 필터 조건 변경 시 ETL 수정 필요  

**옵션 2**: 간단한 필터는 실시간, 복잡한 필터만 ETL  
- ✅ 간단한 필터는 유연하게 변경 가능  
- ✅ 복잡한 필터만 성능 최적화  
- ❌ 계산 방식이 혼재 (일관성 저하)  
- ❌ 쿼리 빌더 복잡도 증가  

### 결정

**옵션 1 채택**: 모든 노이즈 필터를 ETL로 사전 계산

- **ETL 사전 계산** (`build-noise-signals.ts`):
  - 거래량 필터: 20일 평균 거래대금/거래량 계산
  - VCP 필터: ATR(14) + Bollinger Band 계산
  - 캔들 몸통 필터: 최신 거래일 몸통 비율 계산
  - 이평선 밀집 필터: 최신 거래일 MA20-MA50 간격 계산
- **스크리너 쿼리**:
  - `daily_noise_signals` 테이블을 JOIN하여 필터링만 수행

### 근거

1. **일관성**:  
   - 모든 노이즈 필터를 동일한 방식으로 관리하여 코드 가독성 및 유지보수성 향상
2. **성능**:  
   - 모든 계산을 ETL에서 하루 한 번만 수행하여 스크리너 쿼리 성능 유지
   - 스크리너 쿼리는 JOIN + WHERE 수준으로 단순화
3. **확장성**:  
   - 향후 노이즈 필터 추가 시 동일한 패턴 적용 가능
4. **단일 소스**:  
   - 모든 노이즈 신호를 `daily_noise_signals` 테이블에서 관리하여 일관성 보장

### 결과

- `daily_noise_signals` 테이블에 모든 노이즈 필터 관련 컬럼 저장
- 스크리너 쿼리는 `daily_noise_signals` JOIN만 수행
- 필터 조건 변경 시:
  - 모든 필터: ETL 수정 필요 (일관성 유지)

---

## ADR-NF-003: 노이즈 필터를 별도 카테고리로 분리

**날짜**: 2025-12-05  
**상태**: ✅ 채택  
**단계**: 스펙  

### 상황

- 기존 필터 카테고리:
  - `ma`: 이평선 필터
  - `growth`: 성장성 필터
  - `profitability`: 수익성 필터
  - `price`: 가격 필터 (돌파매매)
- 노이즈 필터는 4가지 독립적인 필터로 구성

### 고려 사항

**옵션 1**: 기존 "가격" 카테고리에 통합  
- ✅ 카테고리 수 증가 없음  
- ❌ "가격 필터"의 의미가 모호해짐 (돌파매매 vs 노이즈)  
- ❌ UI에서 필터가 많아져 복잡해짐  

**옵션 2**: 별도 "노이즈" 카테고리 생성 (선택)  
- ✅ 필터 목적이 명확함 (노이즈 제거)  
- ✅ UI에서 필터 그룹이 명확하게 구분됨  
- ❌ 카테고리 수 증가 (5개)  

### 결정

**옵션 2 채택**: "노이즈 필터"를 별도 카테고리로 분리

- `FilterCategory`에 `"noise"` 추가
- `CategoryFilterBox`에 새 항목 추가
- 아이콘: `Filter` 또는 `Sliders` (lucide-react)

### 근거

1. **명확성**:  
   - "노이즈 필터"라는 명확한 목적을 가진 카테고리로 사용자 이해도 향상
2. **확장성**:  
   - 향후 노이즈 관련 필터 추가 시 자연스럽게 확장 가능
3. **UI/UX**:  
   - 필터 그룹이 명확하게 구분되어 사용자가 원하는 필터를 쉽게 찾을 수 있음

### 결과

- 필터 카테고리: `ma`, `growth`, `profitability`, `price`, `noise` (5개)
- 각 카테고리는 독립적으로 관리되며, 필터 요약도 별도로 표시

